{{ define "main" }}

<section class="page-hero">
  <div class="container">
    <h1>{{ .Title }}</h1>
    <p>{{ .Description }}</p>
  </div>
</section>

<section class="section">
  <div class="container">
    <div class="contact-layout">

      {{- /* Contact Info Column */}}
      <div>
        <h2 style="font-size:1.3rem;margin-bottom:var(--space-xl);">Get in touch</h2>
        <dl>
          <div class="contact-info-item">
            <div class="contact-info-icon" aria-hidden="true">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M5 4h4l2 5-2.5 1.5a11 11 0 005 5L15.5 13l5 2v4a2 2 0 01-2 2A16 16 0 012 5a2 2 0 012-2"/></svg>
            </div>
            <div>
              <dt>Phone</dt>
              <dd><a href="tel:{{ .Site.Params.phoneRaw }}">{{ .Site.Params.phone }}</a></dd>
            </div>
          </div>
          <div class="contact-info-item">
            <div class="contact-info-icon" aria-hidden="true">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg>
            </div>
            <div>
              <dt>Email</dt>
              <dd><a href="mailto:{{ .Site.Params.email }}">{{ .Site.Params.email }}</a></dd>
            </div>
          </div>
          <div class="contact-info-item">
            <div class="contact-info-icon" aria-hidden="true">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0118 0z"/><circle cx="12" cy="10" r="3"/></svg>
            </div>
            <div>
              <dt>Address</dt>
              <dd>{{ .Site.Params.address }}</dd>
            </div>
          </div>
          <div class="contact-info-item">
            <div class="contact-info-icon" aria-hidden="true">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
            </div>
            <div>
              <dt>Hours</dt>
              <dd>Mon–Fri: {{ .Site.Params.hours.monday }}<br>Sat: {{ .Site.Params.hours.saturday }}<br>Sun: {{ .Site.Params.hours.sunday }}</dd>
            </div>
          </div>
        </dl>

        {{ with .Site.Params.social.facebook }}
        <div style="margin-top:var(--space-lg);">
          <a href="{{ . }}" target="_blank" rel="noopener noreferrer" class="btn btn-outline btn--sm" aria-label="Firefly Software on Facebook">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/></svg>
            Facebook
          </a>
        </div>
        {{ end }}
      </div>

      {{- /* Contact Form Column */}}
      <div>
        <div
          id="form-status"
          class="form-status"
          role="status"
          aria-live="polite"
          aria-atomic="true"
        ></div>

        <form
          id="contact-form"
          novalidate
          style="background:var(--color-background-alt);border:1px solid var(--color-border-light);border-radius:var(--radius-lg);padding:var(--space-2xl);"
        >
          {{- /* Honeypot — hidden from real users, visible to bots */}}
          <div class="form-honeypot" aria-hidden="true">
            <label for="website">Website (leave blank)</label>
            <input type="text" id="website" name="website" tabindex="-1" autocomplete="off">
          </div>

          <div class="form-group">
            <label class="form-label" for="name">
              Full Name <span class="required" aria-hidden="true">*</span>
            </label>
            <input
              class="form-input"
              type="text"
              id="name"
              name="name"
              required
              aria-required="true"
              autocomplete="name"
              placeholder="Jane Smith"
            >
          </div>

          <div class="form-group">
            <label class="form-label" for="email">
              Email Address <span class="required" aria-hidden="true">*</span>
            </label>
            <input
              class="form-input"
              type="email"
              id="email"
              name="email"
              required
              aria-required="true"
              autocomplete="email"
              placeholder="jane@example.com"
            >
          </div>

          <div class="form-group">
            <label class="form-label" for="phone">Phone Number</label>
            <input
              class="form-input"
              type="tel"
              id="phone"
              name="phone"
              autocomplete="tel"
              placeholder="+1 (406) 555-0100"
            >
          </div>

          <div class="form-group">
            <label class="form-label" for="message">
              Message <span class="required" aria-hidden="true">*</span>
            </label>
            <textarea
              class="form-textarea"
              id="message"
              name="message"
              required
              aria-required="true"
              aria-describedby="message-hint"
              minlength="40"
              maxlength="500"
              placeholder="Tell us about your project or question…"
            ></textarea>
            <p class="form-hint" id="message-hint">Minimum 40 characters. Please give us enough detail to help you.</p>
          </div>

          {{- /* Cloudflare Turnstile */}}
          <div class="form-group">
            <div
              class="cf-turnstile"
              data-sitekey="{{ .Site.Params.turnstileSiteKey }}"
              data-theme="light"
              aria-label="CAPTCHA verification"
            ></div>
          </div>

          <button type="submit" class="btn btn-primary" id="submit-btn" style="width:100%;justify-content:center;">
            Send Message
          </button>
        </form>

        {{- /* Google Maps embed */}}
        <div style="margin-top:var(--space-2xl);border-radius:var(--radius-lg);overflow:hidden;box-shadow:var(--shadow-sm);">
          <iframe
            src="https://www.google.com/maps/embed?pb=!1m18!1m12!1m3!1d2747.8!2d-112.027!3d46.5958!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!3m3!1m2!1s0x0%3A0x0!2zNDbCsDM1JzQ0LjkiTiAxMTLCsDAyJzI1LjkiVw!5e0!3m2!1sen!2sus!4v1700000000000"
            width="100%"
            height="300"
            style="border:0;display:block;"
            allowfullscreen=""
            loading="lazy"
            referrerpolicy="no-referrer-when-downgrade"
            title="Firefly Software location — 652 Jena Loop, Helena, MT 59602"
            aria-label="Google Maps showing Firefly Software location in Helena, Montana"
          ></iframe>
        </div>
      </div>

    </div>
  </div>
</section>

{{ end }}

{{ define "head" }}
<script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script>
{{ end }}

{{ define "scripts" }}
<script>
(function() {
  var form = document.getElementById('contact-form');
  var statusEl = document.getElementById('form-status');
  var submitBtn = document.getElementById('submit-btn');

  if (!form) return;

  function showStatus(msg, type) {
    statusEl.textContent = msg;
    statusEl.className = 'form-status is-' + type;
    statusEl.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
  }

  function clearStatus() {
    statusEl.textContent = '';
    statusEl.className = 'form-status';
  }

  form.addEventListener('submit', function(e) {
    e.preventDefault();
    clearStatus();

    var data = {
      name:     form.name.value.trim(),
      email:    form.email.value.trim(),
      phone:    form.phone.value.trim(),
      message:  form.message.value.trim(),
      website:  form.website.value.trim()
    };

    // Honeypot: if filled, silently pretend success
    if (data.website) {
      showStatus('Thank you! Your message has been sent. We will be in touch shortly.', 'success');
      form.reset();
      return;
    }

    // Basic client-side validation
    if (!data.name) { showStatus('Please enter your full name.', 'error'); return; }
    if (!data.email || !data.email.includes('@')) { showStatus('Please enter a valid email address.', 'error'); return; }
    if (data.message.length < 40) { showStatus('Please write a message of at least 40 characters.', 'error'); return; }

    // Turnstile token
    var turnstileEl = form.querySelector('[name="cf-turnstile-response"]');
    var turnstileToken = turnstileEl ? turnstileEl.value : '';
    data['cf-turnstile-response'] = turnstileToken;

    submitBtn.disabled = true;
    submitBtn.textContent = 'Sending…';

    fetch('/api/contact', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(data)
    })
    .then(function(res) {
      return res.json().then(function(body) { return { status: res.status, body: body }; });
    })
    .then(function(result) {
      if (result.status === 200) {
        showStatus('Thank you! Your message has been sent. We will be in touch shortly.', 'success');
        form.reset();
        if (window.turnstile) window.turnstile.reset();
      } else {
        showStatus(result.body.error || 'Something went wrong. Please try again or call us directly.', 'error');
      }
    })
    .catch(function() {
      showStatus('Network error. Please check your connection and try again, or call us at {{ .Site.Params.phone }}.', 'error');
    })
    .finally(function() {
      submitBtn.disabled = false;
      submitBtn.textContent = 'Send Message';
    });
  });
})();
</script>
{{ end }}
